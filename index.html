<!DOCTYPE html>

<html lang="fr">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Vista • Test Notion connecté Baserow</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>

:root {

--vista-blue: #402c7c;

--bg: #f8f9fa;

--ok: #28a745;

--warn: #ff9800;

--danger: #dc3545;

--muted: #6c757d;

}

- { box-sizing: border-box; }

body { font-family: 'Poppins', sans-serif; background: var(--bg); color: #333; margin: 0; }

.header { background:#fff; padding: 12px 18px; box-shadow: 0 2px 10px rgba(64,44,124,.08); position: sticky; top:0; z-index: 10; }

.header-inner { max-width: 1280px; margin: 0 auto; display:flex; align-items:center; gap:16px; justify-content: space-between; }

.logo img { height: 44px; }

.nav a { color:#fff; text-decoration:none; background: var(--vista-blue); padding:10px 14px; border-radius:8px; font-weight:500; }

.container { max-width: 1280px; margin: 0 auto; padding: 24px 18px; }

.h1 { font-size: 1.8rem; font-weight:600; color: var(--vista-blue); margin: 8px 0 18px; }

.card { background:#fff; border-radius:14px; box-shadow: 0 6px 24px rgba(0,0,0,.08); padding: 18px; margin-bottom: 18px; }

.row { display:grid; gap: 18px; grid-template-columns: 1fr; }

@media(min-width: 1024px) { .row { grid-template-columns: 2fr 1fr; } }

.tabs { display:flex; flex-wrap:wrap; gap: 10px; margin-bottom: 12px; }

.tab { border:2px solid #e5e5e5; background:#f7f7fb; color:#333; padding:10px 14px; border-radius:8px; cursor:pointer; display:flex; gap:8px; align-items:center; }

.tab.active { background: var(--vista-blue); color:#fff; border-color: var(--vista-blue); }

.tab.add { background:#2f9e44; border-color:#2f9e44; color:#fff; }

.grid { display:grid; gap: 4px; }

.grid--w1 { grid-template-columns: 40px repeat(6, 1fr); grid-template-rows: 40px repeat(3, 1fr); }

.grid--w2 { grid-template-columns: 40px repeat(2, 1fr); grid-template-rows: 40px repeat(1, 1fr); }

.cell, .head { border-radius:8px; display:flex; align-items:center; justify-content:center; text-align:center; }

.head { background: var(--vista-blue); color:#fff; font-weight:600; }

.cell { position:relative; border:2px solid #e0e0e0; min-height: 120px; padding: 8px; cursor:pointer; transition: .2s; }

.cell:hover { transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,.12); }

.[cell.free](http://cell.free) { background:#e8f5e8; border-color:#4caf50; color:#2e7d32; }

.cell.busy { background:#e3f2fd; border-color:#2196f3; color:#1565c0; }

.cell.res { background:#fff3e0; border-color:#ff9800; color:#e65100; }

.cell.inactive { background:#f5f5f5; border-color:#bdbdbd; color:#757575; filter: grayscale(40%); opacity:.8; }

.badge { position:absolute; top:6px; left:6px; background: rgba(64,44,124,.9); color:#fff; padding: 2px 8px; border-radius: 10px; font-size:.72rem; font-weight:600; }

.zone { position:absolute; bottom:6px; right:6px; padding: 2px 8px; border-radius: 10px; font-weight:600; font-size:.72rem; }

.zone--on { background:#4caf50; color:#fff; }

.zone--off { background:#f44336; color:#fff; }

.cell-icons { position:absolute; top:6px; right:6px; font-size:.8rem; }

.cell-code { font-weight:700; }

.cell-title { font-size:.85rem; margin-top: 4px; font-weight:600; }

.cell-status { font-size:.78rem; margin-top: 4px; }

.input, select, textarea { width:100%; padding:10px 12px; border:2px solid #e5e5e5; border-radius:8px; font-family:inherit; font-size: 1rem; }

.input:focus, select:focus, textarea:focus { outline:none; border-color: var(--vista-blue); }

.btn { background: var(--vista-blue); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:500; transition:.2s; }

.btn:hover { transform: translateY(-1px); filter: brightness(1.05); }

.btn--muted { background: var(--muted); }

.btn--ok { background: var(--ok); }

.btn--warn { background: var(--warn); color:#333; }

.btn--danger { background: var(--danger); }

.legend { display:flex; flex-wrap:wrap; gap: 16px; align-items:center; }

.legend .dot { width:18px; height:18px; border-radius:4px; border:2px solid #ccc; margin-right:6px; display:inline-block; vertical-align: middle; }

.modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,.45); padding: 24px; z-index: 50; }

.modal__inner { max-width: 900px; margin: auto; background:#fff; border-radius: 14px; overflow: hidden; }

.modal__header { display:flex; align-items:center; justify-content: space-between; padding: 16px 18px; border-bottom: 1px solid #eee; }

.modal__title { font-weight:600; color: var(--vista-blue); }

.modal__body { padding: 18px; max-height: 75vh; overflow:auto; }

.toast { position: fixed; top: 16px; right: 16px; background:#d4edda; border:1px solid #c3e6cb; color:#155724; padding: 10px 14px; border-radius: 10px; transform: translateX(360px); transition: .25s; z-index: 60; }

.[toast.show](http://toast.show) { transform: translateX(0); }

.err { background:#f8d7da; border-color:#f5c6cb; color:#721c24; }

.small { font-size:.9rem; color:#666; }

</style>

</head>

<body>

<header class="header">

<div class="header-inner">

<a class="logo" href="https://associationvista.fr" target="_blank">

<img src="https://swiftask-prod-files.s3.eu-west-3.amazonaws.com/vista_logo.png" alt="Vista">

</a>

<nav class="nav">

<a href="#" onclick="location.reload()"><i class="fa-solid fa-arrows-rotate"></i> Recharger</a>

</nav>

</div>

</header>

<div class="container">

<h1 class="h1">Plan des entrepôts • Contrôle des zones • Stock • Réservations</h1>

<div class="card">

<div class="tabs" id="warehouseTabs">

<button class="tab active" data-warehouse="1" onclick="selectWarehouse(1)"><i class="fa-solid fa-warehouse"></i> Entrepôt 1 - Challans</button>

<button class="tab" data-warehouse="2" onclick="selectWarehouse(2)"><i class="fa-solid fa-boxes-stacked"></i> Entrepôt 2 - Sables d'Olonne</button>

<button class="tab add" onclick="openAddWarehouse()"><i class="fa-solid fa-plus"></i> Ajouter un entrepôt</button>

</div>

<div class="row">

<div>

<div class="card">

<div class="small" style="margin-bottom:10px;">

<input class="input" id="searchInput" placeholder="Rechercher par article, catégorie, zone...">

</div>

<div id="warehouse-1">

<div class="grid grid--w1">

<div class="head"></div>

<div class="head">A</div><div class="head">B</div><div class="head">C</div><div class="head">D</div><div class="head">E</div><div class="head">F</div>

<div class="head">1</div>

<div class="cell inactive" style="grid-column: 2 / 4; grid-row: 2 / 5;">

<div class="cell-title">Espace chantier d'insertion</div>

<div class="cell-status">Zone non-disponible</div>

</div>

<div class="cell inactive" style="grid-column: 4 / 5; grid-row: 2 / 5;">

<div class="cell-title">Espace logistique & bricolage</div>

<div class="cell-status">Zone non-disponible</div>

</div>

<div class="cell free" data-location="D1" data-warehouse="1" onclick="openZone('D1',1)">

<div class="cell-code">D1</div>

<div class="cell-title">Jeux enfants</div>

<div class="cell-status">Libre</div>

<div class="cell-icons"></div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

<div class="cell free" data-location="E1" data-warehouse="1" onclick="openZone('E1',1)">

<div class="cell-code">E1</div>

<div class="cell-title">Hygiène</div>

<div class="cell-status">Libre</div>

<div class="cell-icons"></div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

<div class="cell free" data-location="F1" data-warehouse="1" onclick="openZone('F1',1)">

<div class="cell-code">F1</div>

<div class="cell-title">Vaisselle</div>

<div class="cell-status">Libre</div>

<div class="cell-icons"></div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

<div class="head">2</div>

<div class="cell free" data-location="F2" data-warehouse="1" onclick="openZone('F2',1)">

<div class="cell-code">F2</div>

<div class="cell-title">Lingerie</div>

<div class="cell-status">Libre</div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

<div class="head">3</div>

<div class="cell free" data-location="D2-E3" data-warehouse="1" style="grid-column: 5 / 7; grid-row: 3 / 5;" onclick="openZone('D2-E3',1)">

<div class="cell-code">D2-E3</div>

<div class="cell-title">Stockage logistique</div>

<div class="cell-status">Libre</div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

<div class="cell free" data-location="F3" data-warehouse="1" onclick="openZone('F3',1)">

<div class="cell-code">F3</div>

<div class="cell-title">Fournitures, livres enfants</div>

<div class="cell-status">Libre</div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

</div>

<div id="loading1" class="small" style="text-align:center; padding: 10px;">Chargement Baserow...</div>

</div>

<div id="warehouse-2" style="display:none;">

<div class="grid grid--w2">

<div class="head"></div>

<div class="head">A</div><div class="head">B</div>

<div class="head">1</div>

<div class="cell free" data-location="A1" data-warehouse="2" onclick="openZone('A1',2)">

<div class="cell-code">A1</div>

<div class="cell-title">Étagère bas</div>

<div class="cell-status">Libre</div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

<div class="cell free" data-location="A2" data-warehouse="2" onclick="openZone('A2',2)">

<div class="cell-code">A2</div>

<div class="cell-title">Étagère haut</div>

<div class="cell-status">Libre</div>

<div class="badge" style="display:none;">0</div>

<div class="zone zone--on">Actif</div>

</div>

</div>

<div id="loading2" class="small" style="text-align:center; padding: 10px;">Chargement Baserow...</div>

</div>

</div>

</div>

<div>

<div class="card">

<div class="h1" style="font-size:1.2rem;">Légende</div>

<div class="legend">

Zone libre</span>

Zone occupée 📦</span>

Avec réservations 📅</span>

Zone non-disponible ⛔</span>

</div>

</div>

<div class="card">

<div class="h1" style="font-size:1.2rem;">Réservations en cours</div>

<div id="reservationsPanel" class="small">Chargement...</div>

</div>

</div>

</div>

</div>

</div>

<div class="modal" id="modal">

<div class="modal__inner">

<div class="modal__header">

<div class="modal__title" id="modalTitle">Détails zone</div>

<button class="btn btn--muted" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>

</div>

<div class="modal__body" id="modalBody"></div>

</div>

</div>

<div class="toast" id="toast">Succès</div>

<script>

// CONFIG BASEROW

const BASEROW_API_KEY = 'zYoz2ylTSe42E1CVXimBJR30WvLEFURv';

const BASEROW_BASE_URL = 'https://api.baserow.io/api';

const STOCK_TABLE_ID = 671322;

const CATEGORIES_TABLE_ID = 671321;

const ENTREPOTS_TABLE_ID = 671316;

const PLAN_ENTREPOT_TABLE_ID = 671384;

const RESERVATION_TABLE_ID = 671325;

// ÉTAT LOCAL

let currentWarehouse = 1;

let categories = [];

let zonePositions = {}; // { 'D1': { id: X, status: 'actif' } }

let warehouseData = { 1: {}, 2: {} }; // données par zone

// HELPERS

function showToast(text, isError=false) {

const t = document.getElementById('toast');

t.textContent = text;

t.classList.toggle('err', !!isError);

t.classList.add('show');

setTimeout(()=> t.classList.remove('show'), 2500);

}

function api(path, options={}) {

return fetch(`${BASEROW_BASE_URL}${path}`, {

...options,

headers: {

'Authorization': `Token ${BASEROW_API_KEY}`,

'Content-Type': 'application/json',

...(options.headers||{})

}

});

}

// INIT

document.addEventListener('DOMContentLoaded', async () => {

document.getElementById('searchInput').addEventListener('input', applySearch);

await Promise.all([

loadCategories(),

loadZonePositions(),

loadReservations()

]);

await loadStock();

updateAllCells();

document.getElementById('loading1').style.display = 'none';

document.getElementById('loading2').style.display = 'none';

});

// CHARGEMENTS

async function loadCategories() {

const r = await api(`/database/rows/table/${CATEGORIES_TABLE_ID}/?user_field_names=false`);

if (!r.ok) return;

const data = await r.json();

categories = [data.results.map](http://data.results.map)(it => ({ id: [it.id](http://it.id), nom: it.field_5527913 }));

}

async function loadZonePositions() {

const r = await api(`/database/rows/table/${PLAN_ENTREPOT_TABLE_ID}/?user_field_names=false`);

if (!r.ok) return;

const data = await r.json();

zonePositions = {};

data.results.forEach(row => {

const position = row.field_5528810; // Position

let etat = 'actif';

const raw = row.field_5542793; // multi-select

if (raw) {

if (Array.isArray(raw)) {

etat = raw.includes('inactif') ? 'inactif' : 'actif';

} else if (typeof raw === 'string') {

etat = raw.toLowerCase() === 'inactif' ? 'inactif' : 'actif';

}

}

if (position) zonePositions[position] = { id: [row.id](http://row.id), status: etat };

});

}

async function loadStock() {

const r = await api(`/database/rows/table/${STOCK_TABLE_ID}/?user_field_names=false`);

if (!r.ok) return;

const data = await r.json();

warehouseData = { 1: {}, 2: {} };

// Initialise zones connues pour conserver affichage

['D1','E1','F1','D2-E3','F2','F3'].forEach(p => warehouseData[1][p] = { items: [], occupied:false, hasRes:false, zoneStatus: (zonePositions[p]?.status||'actif') });

['A1','A2'].forEach(p => warehouseData[2][p] = { items: [], occupied:false, hasRes:false, zoneStatus: (zonePositions[p]?.status||'actif') });

data.results.forEach(row => {

const name = row.field_5527921 || 'Article';

const quantity = +row.field_5527934 || 0;

const reserved = +row.field_5532799 || 0;

const price = +row.field_5529132 || 0;

const type = row.field_5529130 || 'Don';

const etat = row.field_5615747 || 'Bon état';

let pos = null, w = 1;

if (Array.isArray(row.field_5532813) && row.field_5532813.length) {

const val = row.field_5532813[0].value;

pos = val; w = (val === 'A1' || val === 'A2') ? 2 : 1;

}

if (!pos || !warehouseData[w] || !warehouseData[w][pos]) return;

const catName = (()=>{

if (Array.isArray(row.field_5529113) && row.field_5529113.length) {

const id = row.field_5529113[0];

const c = categories.find(x=>[x.id](http://x.id)===id); return c?c.nom:'Autre';

}

return 'Autre';

})();

warehouseData[w][pos].items.push({

id: [row.id](http://row.id), name, quantity, reserved, price, type, etat, category: catName

});

warehouseData[w][pos].occupied = true;

warehouseData[w][pos].hasRes = reserved>0;

});

}

async function loadReservations() {

const r = await api(`/database/rows/table/${RESERVATION_TABLE_ID}/?user_field_names=false`);

if (!r.ok) { document.getElementById('reservationsPanel').textContent = 'Erreur de chargement'; return; }

const data = await r.json();

if (!data.results?.length) { document.getElementById('reservationsPanel').textContent = 'Aucune réservation'; return; }

const lines = [data.results.map](http://data.results.map)(r=>{

const nom = r.field_5527943 || 'Article';

const q = r.field_5527944 || 0;

const who = r.field_5527945 || `${r.field_5615909||''} ${r.field_5615908||''}`.trim();

const etat = Array.isArray(r.field_5527990) ? r.field_5527990.join(', ') : (r.field_5527990||'');

const id = [r.id](http://r.id);

return `<div style="display:flex; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid #eee;">

<div><strong>${nom}</strong> • ${q} • ${who} • ${etat}</div>

<div>

<button class="btn btn--ok" onclick="editReservation(${id})">Modifier</button>

<button class="btn btn--danger" onclick="deleteReservation(${id})">Supprimer</button>

</div>

</div>`

}).join('');

document.getElementById('reservationsPanel').innerHTML = lines;

}

// AFFICHAGE

function selectWarehouse(id) {

currentWarehouse = id;

document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));

document.querySelector(`.tab[data-warehouse="${id}"]`).classList.add('active');

document.getElementById('warehouse-1').style.display = id===1? 'block':'none';

document.getElementById('warehouse-2').style.display = id===2? 'block':'none';

updateAllCells();

}

function updateAllCells() {

document.querySelectorAll(`#warehouse-${currentWarehouse} .cell[data-location]`).forEach(cell => {

const loc = cell.dataset.location; const w = +cell.dataset.warehouse;

const d = warehouseData[w]?.[loc] || { items:[], occupied:false, hasRes:false, zoneStatus: (zonePositions[loc]?.status||'actif') };

const badge = cell.querySelector('.badge');

const status = cell.querySelector('.cell-status');

const zone = cell.querySelector('.zone');

const count = d.items.length;

[badge.style](http://badge.style).display = count? 'block':'none';

badge.textContent = count;

cell.classList.remove('free','busy','res','inactive');

if (d.zoneStatus === 'inactif') cell.classList.add('inactive');

if (d.occupied) {

if (d.hasRes) { cell.classList.add('res'); status.textContent = `${count} article(s)`; }

else { cell.classList.add('busy'); status.textContent = `${count} article(s)`; }

} else { cell.classList.add('free'); status.textContent = 'Libre'; }

zone.textContent = d.zoneStatus === 'actif'? 'Actif':'Inactif';

zone.className = `zone ${d.zoneStatus === 'actif' ? 'zone--on' : 'zone--off'}`;

});

}

function applySearch(e) {

const term = (e?.target?.value || document.getElementById('searchInput').value || '').toLowerCase();

document.querySelectorAll(`#warehouse-${currentWarehouse} .cell[data-location]`).forEach(cell => {

const loc = cell.dataset.location; const w = +cell.dataset.warehouse;

const d = warehouseData[w]?.[loc] || { items:[] };

const match = loc.toLowerCase().includes(term)

|  | (cell.querySelector('.cell-title')?.textContent.toLowerCase().includes(term)) |
| --- | --- |
|  | d.items.some(it => ([it.name](http://it.name) |

[cell.style](http://cell.style).display = match? 'flex':'none';

});

}

// MODAL ZONE

function openZone(location, warehouse) {

const d = warehouseData[warehouse]?.[location] || { items:[], zoneStatus: (zonePositions[location]?.status||'actif') };

document.getElementById('modalTitle').textContent = `Entrepôt ${warehouse} • Zone ${location}`;

let html = '';

html += `<div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">

Statut zone: <strong>${d.zoneStatus==='actif'?'🟢 Active':'🔴 Inactive'}</strong>

<button class="btn btn--warn" onclick="openZoneStatus('${location}', ${warehouse})"><i class='fa-solid fa-toggle-on'></i> Gérer la zone</button>

</div>`;

if (!d.items.length) {

html += `<div class="card small" style="background:#dff7e1;">Zone libre. Ajoutez un article pour commencer.</div>

<button class="btn" onclick="openAddItem('${location}', ${warehouse})"><i class='fa-solid fa-plus'></i> Ajouter un article</button>`;

} else {

html += `<div class="h1" style="font-size:1.1rem;">Articles (${d.items.length})</div>`;

d.items.forEach(it => {

const avail = (it.quantity||0) - (it.reserved||0);

html += `<div class="card">

<div style="display:flex; justify-content:space-between; align-items:center;">

<div><strong>${[it.name](http://it.name)}</strong> ${it.type==='Don'?'🎁':'💰'} • ${it.category}</div>

<div class='small'>Stock ${it.quantity} • Réservé ${it.reserved} • Dispo <strong>${avail}</strong></div>

</div>

<div style="display:flex; gap:8px; margin-top:8px;">

<button class="btn btn--warn" onclick="openEditItem(${[it.id](http://it.id)}, '${location}', ${warehouse})">Modifier</button>

<button class="btn btn--ok" onclick="openReserve(${[it.id](http://it.id)}, '${location}', ${warehouse})">Réserver</button>

<button class="btn btn--danger" onclick="deleteItem(${[it.id](http://it.id)}, '${location}', ${warehouse}, '${[it.name](http://it.name)}')">Supprimer</button>

</div>

</div>`;

});

html += `<div style="margin-top:10px;"><button class="btn" onclick="openAddItem('${location}', ${warehouse})"><i class='fa-solid fa-plus'></i> Ajouter un article</button></div>`;

}

document.getElementById('modalBody').innerHTML = html;

document.getElementById('modal').style.display = 'block';

}

function closeModal(){ document.getElementById('modal').style.display = 'none'; }

// GESTION STATUT ZONE

function openZoneStatus(location, warehouse){

const status = warehouseData[warehouse]?.[location]?.zoneStatus || (zonePositions[location]?.status||'actif');

document.getElementById('modalBody').innerHTML = `

<div class='h1' style='font-size:1.1rem;'>Changer le statut</div>

<div class='small' style='margin:8px 0 12px;'>Zone ${location} • Entrepôt ${warehouse}</div>

<label class='small'>Statut</label>

<select id='zoneStatusSel' class='input'>

<option value='actif' ${status==='actif'?'selected':''}>Actif</option>

<option value='inactif' ${status==='inactif'?'selected':''}>Inactif</option>

</select>

<div style='margin-top:12px; display:flex; gap:8px;'>

<button class='btn' onclick="saveZoneStatus('${location}', ${warehouse})">Enregistrer</button>

<button class='btn btn--muted' onclick="openZone('${location}', ${warehouse})">Annuler</button>

</div>

`;

}

async function saveZoneStatus(location, warehouse){

const newStatus = document.getElementById('zoneStatusSel').value;

const info = zonePositions[location];

if (!info) { showToast('Position inconnue', true); return; }

const payload = { field_5542793: [newStatus] };

const r = await api(`/database/rows/table/${PLAN_ENTREPOT_TABLE_ID}/${[info.id](http://info.id)}/`, { method:'PATCH', body: JSON.stringify(payload) });

if (!r.ok) { const tx = await r.text(); showToast('Erreur maj zone', true); console.error(tx); return; }

warehouseData[warehouse][location].zoneStatus = newStatus;

zonePositions[location].status = newStatus;

updateAllCells();

showToast(`Zone ${location} → ${newStatus}`);

openZone(location, warehouse);

}

// CRUD ARTICLES

function openAddItem(location, warehouse){

const opts = [categories.map](http://categories.map)(c=>`<option value='${[c.id](http://c.id)}'>${c.nom}</option>`).join('');

document.getElementById('modalBody').innerHTML = `

<div class='h1' style='font-size:1.1rem;'>Ajouter un article</div>

<div class='row' style='grid-template-columns:1fr 1fr;'>

<div><label class='small'>Nom *</label><input id='itName' class='input' required></div>

<div><label class='small'>Quantité *</label><input id='itQty' type='number' min='1' value='1' class='input' required></div>

<div><label class='small'>Prix unitaire (€)</label><input id='itPrice' type='number' step='0.01' min='0' value='0' class='input'></div>

<div><label class='small'>Catégorie</label><select id='itCat' class='input'><option value=''>—</option>${opts}</select></div>

<div><label class='small'>Type *</label><select id='itType' class='input'><option value='Don'>Don</option><option value='Achat'>Achat</option></select></div>

<div><label class='small'>État *</label><select id='itEtat' class='input'><option value='Neuf'>Neuf</option><option value='Bon état'>Bon état</option></select></div>

<div style='grid-column:1 / -1;'><label class='small'>Site fournisseur</label><input id='itSite' class='input' placeholder='https://...'></div>

</div>

<div style='margin-top:12px; display:flex; gap:8px;'>

<button class='btn' onclick="saveNewItem('${location}', ${warehouse})">Ajouter</button>

<button class='btn btn--muted' onclick="openZone('${location}', ${warehouse})">Annuler</button>

</div>

`;

}

async function saveNewItem(location, warehouse){

const name = document.getElementById('itName').value.trim();

const quantity = +document.getElementById('itQty').value;

const price = +document.getElementById('itPrice').value;

const cat = document.getElementById('itCat').value;

const type = document.getElementById('itType').value;

const etat = document.getElementById('itEtat').value;

const site = document.getElementById('itSite').value.trim();

if (!name || !quantity) { showToast('Champs requis manquants', true); return; }

const posInfo = zonePositions[location]; if (!posInfo) { showToast('Position inconnue', true); return; }

// Trouver l'entrepôt lié par ID_Entrepôt == warehouse

let entrepotId = null;

const ent = await api(`/database/rows/table/${ENTREPOTS_TABLE_ID}/?user_field_names=false`);

if (ent.ok) { const ed = await ent.json(); const row = ed.results.find(e=> e.field_5527870 === warehouse); if (row) entrepotId = [row.id](http://row.id); }

const payload = {

field_5527921: name,

field_5527934: quantity,

field_5529132: price,

field_5529130: type,

field_5615747: etat,

field_5615690: new Date().toISOString().split('T')[0],

field_5532813: [[posInfo.id](http://posInfo.id)]

};

if (entrepotId) payload.field_5527922 = [entrepotId];

if (cat) payload.field_5529113 = [parseInt(cat)];

if (site) payload.field_5529271 = site;

const r = await api(`/database/rows/table/${STOCK_TABLE_ID}/`, { method:'POST', body: JSON.stringify(payload) });

if (!r.ok) { showToast('Erreur ajout', true); return; }

await loadStock(); updateAllCells(); showToast('Article ajouté'); openZone(location, warehouse);

}

async function openEditItem(id, location, warehouse){

const r = await api(`/database/rows/table/${STOCK_TABLE_ID}/${id}/?user_field_names=false`);

if (!r.ok) { showToast('Article introuvable', true); return; }

const it = await r.json();

const opts = [categories.map](http://categories.map)(c=>`<option value='${[c.id](http://c.id)}' ${(it.field_5529113||[]).includes([c.id](http://c.id))?'selected':''}>${c.nom}</option>`).join('');

document.getElementById('modalBody').innerHTML = `

<div class='h1' style='font-size:1.1rem;'>Modifier l'article</div>

<div class='row' style='grid-template-columns:1fr 1fr;'>

<div><label class='small'>Nom *</label><input id='editName' class='input' value='${it.field_5527921||''}'></div>

<div><label class='small'>Quantité *</label><input id='editQty' type='number' min='0' class='input' value='${it.field_5527934||0}'></div>

<div><label class='small'>Prix unitaire</label><input id='editPrice' type='number' step='0.01' class='input' value='${it.field_5529132||0}'></div>

<div><label class='small'>Catégorie</label><select id='editCat' class='input'><option value=''>—</option>${opts}</select></div>

<div><label class='small'>Type</label><select id='editType' class='input'><option value='Don' ${it.field_5529130==='Don'?'selected':''}>Don</option><option value='Achat' ${it.field_5529130==='Achat'?'selected':''}>Achat</option></select></div>

<div><label class='small'>État</label><select id='editEtat' class='input'><option value='Neuf' ${it.field_5615747==='Neuf'?'selected':''}>Neuf</option><option value='Bon état' ${it.field_5615747==='Bon état'?'selected':''}>Bon état</option></select></div>

</div>

<div style='margin-top:12px; display:flex; gap:8px;'>

<button class='btn' onclick="saveEditItem(${id}, '${location}', ${warehouse})">Enregistrer</button>

<button class='btn btn--muted' onclick="openZone('${location}', ${warehouse})">Annuler</button>

</div>

`;

}

async function saveEditItem(id, location, warehouse){

const payload = {

field_5527921: document.getElementById('editName').value.trim(),

field_5527934: +document.getElementById('editQty').value,

field_5529132: +document.getElementById('editPrice').value,

field_5529130: document.getElementById('editType').value,

field_5615747: document.getElementById('editEtat').value,

field_5615692: new Date().toISOString().split('T')[0]

};

const cat = document.getElementById('editCat').value; payload.field_5529113 = cat? [parseInt(cat)] : [];

const r = await api(`/database/rows/table/${STOCK_TABLE_ID}/${id}/`, { method:'PATCH', body: JSON.stringify(payload) });

if (!r.ok) { showToast('Erreur modification', true); return; }

await loadStock(); updateAllCells(); showToast('Article modifié'); openZone(location, warehouse);

}

async function deleteItem(id, location, warehouse, name){

if (!confirm(`Supprimer définitivement "${name}" ?`)) return;

const r = await api(`/database/rows/table/${STOCK_TABLE_ID}/${id}/`, { method:'DELETE' });

if (!r.ok) { showToast('Erreur suppression', true); return; }

await loadStock(); updateAllCells(); showToast('Article supprimé'); openZone(location, warehouse);

}

// RESERVATIONS

async function openReserve(id, location, warehouse){

const r = await api(`/database/rows/table/${STOCK_TABLE_ID}/${id}/?user_field_names=false`);

if (!r.ok) { showToast('Article introuvable', true); return; }

const it = await r.json();

const available = (+it.field_5527934||0) - (+it.field_5532799||0);

document.getElementById('modalBody').innerHTML = `

<div class='h1' style='font-size:1.1rem;'>Créer une réservation</div>

<div class='small'>${it.field_5527921} • dispo ${available}</div>

<div class='row' style='grid-template-columns:1fr 1fr;'>

<div><label class='small'>Prénom *</label><input id='rp' class='input'></div>

<div><label class='small'>Nom *</label><input id='rn' class='input'></div>

<div><label class='small'>Quantité *</label><input id='rq' type='number' min='1' max='${available}' value='1' class='input'></div>

<div><label class='small'>Téléphone</label><input id='rt' class='input'></div>

<div><label class='small'>Email</label><input id='re' type='email' class='input'></div>

<div><label class='small'>Date réservation *</label><input id='rdr' type='date' class='input' value='${new Date().toISOString().split('T')[0]}'></div>

<div><label class='small'>Date retrait</label><input id='rde' type='date' class='input'></div>

<div style='grid-column:1 / -1;'><label class='small'>Commentaire</label><textarea id='rc' class='input' rows='2'></textarea></div>

</div>

<div style='margin-top:12px; display:flex; gap:8px;'>

<button class='btn' onclick="saveReservation(${id}, '${location}', ${warehouse})">Créer</button>

<button class='btn btn--muted' onclick="openZone('${location}', ${warehouse})">Annuler</button>

</div>

`;

}

async function saveReservation(stockId, location, warehouse){

const prenom = document.getElementById('rp').value.trim();

const nom = document.getElementById('rn').value.trim();

const q = +document.getElementById('rq').value;

const tel = document.getElementById('rt').value.trim();

const email = document.getElementById('re').value.trim();

const dres = document.getElementById('rdr').value; const dret = document.getElementById('rde').value;

const com = document.getElementById('rc').value.trim();

if (!prenom || !nom || !q) { showToast('Champs requis', true); return; }

// Récupère le nom produit

const s = await api(`/database/rows/table/${STOCK_TABLE_ID}/${stockId}/?user_field_names=false`); const item = await s.json();

const payload = {

field_5527943: item.field_5527921,

field_5527944: q,

field_5527945: `${prenom} ${nom}`,

field_5615909: prenom,

field_5615908: nom,

field_5527986: dres,

field_5527990: ['En attente'],

field_5529273: [stockId]

};

if (tel) payload.field_5615903 = parseInt(tel);

if (email) payload.field_5615904 = email;

if (dret) payload.field_5527991 = dret;

if (com) payload.field_5615910 = com;

const r = await api(`/database/rows/table/${RESERVATION_TABLE_ID}/`, { method:'POST', body: JSON.stringify(payload) });

if (!r.ok) { showToast('Erreur réservation', true); return; }

await loadStock(); updateAllCells(); await loadReservations(); showToast('Réservation créée'); openZone(location, warehouse);

}

async function editReservation(id){

const r = await api(`/database/rows/table/${RESERVATION_TABLE_ID}/${id}/?user_field_names=false`); if (!r.ok) { showToast('Introuvable', true); return; }

const res = await r.json();

document.getElementById('modalTitle').textContent = 'Modifier la réservation';

document.getElementById('modal').style.display = 'block';

document.getElementById('modalBody').innerHTML = `

<div class='row' style='grid-template-columns:1fr 1fr;'>

<div><label class='small'>Bénéficiaire</label><input id='er_name' class='input' value='${res.field_5527945||''}'></div>

<div><label class='small'>Quantité</label><input id='er_q' class='input' type='number' value='${res.field_5527944||0}'></div>

<div><label class='small'>État</label><select id='er_state' class='input'><option ${Array.isArray(res.field_5527990)&&res.field_5527990.includes('En attente')?'selected':''}>En attente</option><option ${Array.isArray(res.field_5527990)&&res.field_5527990.includes('Retiré')?'selected':''}>Retiré</option></select></div>

<div><label class='small'>Date réservation</label><input id='er_dr' class='input' type='date' value='${res.field_5527986||''}'></div>

<div><label class='small'>Date retrait</label><input id='er_de' class='input' type='date' value='${res.field_5527991||''}'></div>

<div style='grid-column:1 / -1;'><label class='small'>Commentaire</label><textarea id='er_c' class='input'>${res.field_5615910||''}</textarea></div>

</div>

<div style='margin-top:12px; display:flex; gap:8px;'>

<button class='btn' onclick='saveReservationEdit(${id})'>Enregistrer</button>

<button class='btn btn--muted' onclick="document.getElementById('modal').style.display='none'">Fermer</button>

</div>

`;

}

async function saveReservationEdit(id){

const payload = {

field_5527945: document.getElementById('er_name').value,

field_5527944: +document.getElementById('er_q').value,

field_5527990: [document.getElementById('er_state').value],

field_5527986: document.getElementById('er_dr').value || null,

field_5527991: document.getElementById('er_de').value || null,

field_5615910: document.getElementById('er_c').value || null

};

const r = await api(`/database/rows/table/${RESERVATION_TABLE_ID}/${id}/`, { method:'PATCH', body: JSON.stringify(payload) });

if (!r.ok) { showToast('Erreur modification', true); return; }

await loadStock(); updateAllCells(); await loadReservations(); showToast('Réservation modifiée'); document.getElementById('modal').style.display='none';

}

async function deleteReservation(id){

if (!confirm('Supprimer cette réservation ?')) return;

const r = await api(`/database/rows/table/${RESERVATION_TABLE_ID}/${id}/`, { method:'DELETE' });

if (!r.ok) { showToast('Erreur suppression', true); return; }

await loadStock(); updateAllCells(); await loadReservations(); showToast('Réservation supprimée');

}

// AJOUT D'UN NOUVEL ENTREPÔT

function openAddWarehouse(){

document.getElementById('modalTitle').textContent = 'Ajouter un entrepôt';

document.getElementById('modal').style.display = 'block';

document.getElementById('modalBody').innerHTML = `

<div class='row' style='grid-template-columns:1fr 1fr;'>

<div><label class='small'>ID Entrepôt (nombre) *</label><input id='ew_id' class='input' type='number' min='1'></div>

<div><label class='small'>Localisation *</label><input id='ew_loc' class='input'></div>

<div><label class='small'>Superficie (m²)</label><input id='ew_s' class='input' type='number' min='0'></div>

<div><label class='small'>Taille (L x l, m)</label><div style='display:flex; gap:8px;'><input id='ew_L' class='input' type='number' min='0' placeholder='L'><input id='ew_l' class='input' type='number' min='0' placeholder='l'></div></div>

</div>

<div style='margin-top:12px; display:flex; gap:8px;'>

<button class='btn' onclick='saveWarehouse()'>Créer</button>

<button class='btn btn--muted' onclick="document.getElementById('modal').style.display='none'">Annuler</button>

</div>

`;

}

async function saveWarehouse(){

const id = +document.getElementById('ew_id').value; const loc = document.getElementById('ew_loc').value.trim();

const S = +document.getElementById('ew_s').value; const L = +document.getElementById('ew_L').value; const l = +document.getElementById('ew_l').value;

if (!id || !loc) { showToast('Champs requis', true); return; }

const payload = {

field_5527870: id,

field_5527887: loc,

field_5527883: S||null,

field_5527884: L||null,

field_5527885: l||null

};

const r = await api(`/database/rows/table/${ENTREPOTS_TABLE_ID}/`, { method:'POST', body: JSON.stringify(payload) });

if (!r.ok) { const tx = await r.text(); console.error(tx); showToast('Erreur création entrepôt', true); return; }

showToast('Entrepôt créé'); document.getElementById('modal').style.display='none';

// Option: ajouter un onglet visuel immédiatement

const tabs = document.getElementById('warehouseTabs');

const b = document.createElement('button'); b.className='tab'; b.dataset.warehouse=id; b.innerHTML=`<i class="fa-solid fa-warehouse"></i> Entrepôt ${id} - ${loc}`; b.onclick=()=>selectWarehouse(id);

tabs.insertBefore(b, tabs.lastElementChild);

}

</script>

</body>

</html>
